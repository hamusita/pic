	LIST	P=PIC16F84A
	#INCLUDE<P16F84A.INC>
	
	__CONFIG	_HS_OSC&_CP_OFF&_WDT_OFF&_PWRTE_ON
;****変数領域確保***********************************************************		
W_TEMP		EQU	0CH
STATUS_TEMP	EQU	0DH
TMP			EQU	0EH

COUNT		EQU 0FH
NOW			EQU 11H

OUTPUT1		EQU 12H
OUTPUT2		EQU 13H

WORK		EQU 14H
BCD1		EQU	15H
BCD2		EQU	16H
CNT			EQU	17H
;*************************************************************************		

	ORG	0H
	GOTO	MAIN
		
;****割り込み処理************************************************************		

	ORG		04H
		
;PUSH
	MOVWF	W_TEMP
	MOVF	STATUS,W
	MOVWF	STATUS_TEMP

	BTFSC	PORTB,7
	CALL	UNDER
	BTFSC	PORTB,6
	CALL	OVER
	NOP
	NOP

	MOVF	STATUS_TEMP,W
	MOVWF	STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W
	BCF		INTCON,RBIF	;
	RETFIE


OVER
	INCF	COUNT,F
	MOVF 	COUNT,W
	MOVWF	WORK
	CALL	BCDC
	BTFSC 	BCD2,0
	GOTO	OST
	INCF	NOW,F
	MOVF 	NOW,W
	MOVWF	WORK
	CALL	BCDC
	CALL	OUTPUT

	RETURN
		
UNDER
	INCF 	COUNT,F
	DECFSZ 	COUNT,F
	GOTO	UNDER2
	GOTO	UST
UNDER2
	DECF	COUNT,F
	DECF	NOW,F
	MOVF 	NOW,W
	MOVWF	WORK
	CALL	BCDC
	CALL	OUTPUT

	RETURN

BCDC
	CLRF	CNT
	CLRF	BCD1
	CLRF	BCD2
	MOVLW	D'8'	;8回繰り返す
	MOVWF	CNT	 	;CNT=8
	BCF		STATUS,C
BCDC_2
	RLF		WORK,F	 ;全体的に左に回す
	RLF		BCD1,F
	RLF		BCD2,F
	BTFSC	STATUS,C ;DEC1に移動するビット(0=SKIP)
	BSF		BCD1,0	 ;C=1
	DECFSZ	CNT,F
	GOTO	BCDC_6	 ;LOOP<8
	GOTO	BCDC_5	 ;LOOP=8
BCDC_6
	MOVLW	0x03	 ;W=0x03
	ADDWF	BCD1,F	 ;[BCD1]+03H
	BTFSC	BCD1,3	 ;4bit => 5?
	GOTO	BCDC_3	 ;     => 5 (5~)
	MOVLW	0x03	 ;W=0x03
	SUBWF	BCD1,F	 ;[BCD1]-03H
BCDC_3
	MOVLW	0x30	 ;W=0x30
	ADDWF	BCD1,F	 ;[BCD1]+30H
	BTFSC	BCD1,7	 ;8BIT =>5?
	GOTO	BCDC_4	 ;     =>5 (5~)
	MOVLW	0x30	 ;W=0x30
	SUBWF	BCD1,F	 ;[BCD1]-30H
BCDC_4
	MOVLW	0x03	 ;W=0x03
	ADDWF	BCD2,F	 ;[BCD2]-03H
	BTFSC	BCD2,3	 ;12BIT =>5?
	GOTO	BCDC_2	 ;	=>5 (5~)
	MOVLW	0x03	 ;W=0x03
	SUBWF	BCD2,F	 ;[BCD2]-03H
	GOTO	BCDC_2
BCDC_5
	RETURN
	

OST
	CLRF	COUNT
	CLRF	NOW
	CLRF	BCD1
	CLRF	BCD2

	CALL	OUTPUT

	MOVF	STATUS_TEMP,W
	MOVWF	STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W
	BCF		INTCON,RBIF
	RETFIE

UST
	MOVLW	D'99'
	MOVWF	COUNT
	MOVLW	D'99'
	MOVWF	NOW
	MOVLW	D'99'
	MOVWF	WORK

	CALL	BCDC

	CALL	OUTPUT

	MOVF	STATUS_TEMP,W
	MOVWF	STATUS
	SWAPF	W_TEMP,F
	SWAPF	W_TEMP,W
	BCF		INTCON,RBIF
	RETFIE

OUTPUT
	MOVF	BCD1,W
	MOVWF	PORTB
	SWAPF 	BCD1,W
	BCF		W,5
	MOVWF	PORTA
	RETURN

WAIT
	DECFSZ 	WORK,F
	GOTO	WAIT
	RETURN
	
		
;****メイン処理**************************************************************		
MAIN
	BCF		INTCON,RBIE	;変化割り込み不許可
	BSF		STATUS,RP0
	CLRF	TRISA		;PORTA output
	MOVLW	0F0H		;
	MOVWF	TRISB		;RB7~4 INPUT
	BCF		STATUS,RP0	;
	BSF		INTCON,GIE	;割り込み許可
	BSF		INTCON,RBIE	;変化割り込み許可
	CLRF	PORTA
	CLRF	PORTB
	CLRF	TMP
	CLRF	NOW
	CLRF	COUNT
	CLRF	WORK
		
LOOP
	NOP
   	GOTO	LOOP
		
	END
