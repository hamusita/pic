LIST P=PIC16F84A
   #INCLUDE<P16F84A.INC>

   __CONFIG _HS_OSC & _CP_OFF & _WDT_OFF & _PWRTE_ON
  
W_TEMP  EQU  0CH
STATUS_TEMP EQU  0DH
CNT1  EQU  0EH
CNTB  EQU  0FH
TMPA  EQU  010H
OUT   EQU  011H
IN   EQU  012H
TMP   EQU  013H
CNT10  EQU  014H
TMP1X  EQU  015H
TMP1Y  EQU  016H
TMP2X  EQU  017H
TMP2Y  EQU  018H
OPERATOR EQU  019H
TEMP0  EQU  01AH
TEMP1  EQU  01BH
TEMP2  EQU  01CH
TEMP3  EQU  01DH
PL02  EQU  01EH
PL13  EQU  01FH
CARRY  EQU  020H
JUDGE  EQU  021H
SB02  EQU  022H
SB13  EQU  023H

   ORG  0H
   GOTO MAIN
   
   ORG  04H

;PUSH
   MOVWF W_TEMP
   MOVF STATUS, W
   MOVWF STATUS_TEMP
   
   CALL CRECV
   MOVWF OUT
   
   BTFSS CNT10, 0
   GOTO TMP_0
   BTFSS CNT10, 1
   GOTO TMP_1
   BTFSS CNT10, 2
   GOTO TMP_OPE
   BTFSS CNT10, 3
   GOTO TMP_2
   BTFSS CNT10, 4
   GOTO TMP_3
   BTFSS CNT10, 5
   GOTO EQUAL
   
   GOTO POP

            

POP
   MOVF STATUS_TEMP, W
   MOVWF STATUS
   SWAPF W_TEMP, F
   SWAPF W_TEMP, W
   BCF  INTCON, INTF 
   RETFIE  

MAIN
   BSF  STATUS, RP0
   BCF  INTCON, GIE
   CLRF TRISA
   MOVLW B'00000001'
   MOVWF TRISB
   
   BCF  STATUS, C
   BCF  OPTION_REG, INTEDG
   BCF  STATUS, RP0
   CLRF CARRY
   CLRF CNT10
   BSF  INTCON, GIE
   BSF  INTCON, INTE

MAINLP
   BTFSC CNT10, 5
   CALL ANSWER
   
   GOTO MAINLP
ANSWER
   BTFSC JUDGE, 0
   CALL KASANN
   RETURN

CRECV
   CLRF TMPA
   MOVLW 08H
   MOVWF CNTB
   CALL TIME156

CRECVLP
   BTFSC PORTB, 0
   BSF  STATUS, C
   BTFSS PORTB, 0
   BCF  STATUS, C
   RRF  TMPA, F
   CALL TIME104
   DECFSZ CNTB, F
   GOTO CRECVLP
   MOVF TMPA, W 
   
   RETURN

KASANN
   MOVF TMP1X, W
   ANDLW B'00001111'
   MOVWF TEMP0
   
   MOVF TMP2X, W
   ANDLW B'00001111'
   MOVWF TEMP2
   
   MOVF TMP1Y, W
   ANDLW B'00001111'
   MOVWF TEMP1
   
   MOVF TMP2Y, W
   ANDLW B'00001111'
   MOVWF TEMP3
   
   
   MOVF TEMP1, W
   ADDWF TEMP3, W
   MOVWF PL13
   
   MOVLW 0AH
   SUBWF PL13, W    
   BTFSC STATUS, C  
   CALL LANKUP
   
   
   MOVF TEMP0, W
   ADDWF TEMP2, W   
   ADDWF CARRY, W   
   MOVWF PL02
 
   MOVLW 0AH
   SUBWF PL02, W 
   
   BTFSC STATUS, C  
   CALL LANKUP2  
   
   
   MOVF PL02, W 
   ADDLW B'00110000' 
   CALL CSEND
   
   MOVF PL13, W 
   ADDLW B'00110000'  
   CALL CSEND   
   CALL ROUTINE
   CLRF CARRY
   RETURN

ROUTINE
   MOVLW B'00001101'
   CALL CSEND
   MOVLW B'00001010'
   CALL CSEND   
   CLRF CNT10
   RETURN
   
LANKUP
   BSF  CARRY, 0  
   
   MOVLW 0AH
   SUBWF PL13, F
   RETURN
   
LANKUP2
   MOVLW B'00110001' 
   CALL CSEND
   MOVLW 0AH
   SUBWF PL02, F 
   RETURN



CSEND
   MOVWF IN
   MOVLW 08H
   MOVWF CNTB
   BCF  PORTA, 4
   CALL TIME104
CSENDLP
   BTFSC IN, 0
   BSF  PORTA, 4
   BTFSS IN, 0
   BCF  PORTA, 4
   CALL TIME104
   RRF  IN, F
   DECFSZ CNTB, F
   GOTO CSENDLP
   BSF  PORTA, 4
   CALL TIME104
   RETURN

TIME156
   MOVLW 0C3H
   MOVWF CNT1
LOOP1
   NOP
   DECFSZ CNT1, F
   GOTO LOOP1
   RETURN

TIME104
   MOVLW 082H
   MOVWF CNT1 
LOOP2
   NOP
   DECFSZ CNT1, F
   GOTO LOOP2
   RETURN
TMP_0
   MOVF OUT,W
   MOVWF TMP1X
   CALL CSEND
   BSF  CNT10, 0
   GOTO POP
TMP_1
   MOVF OUT, W
   MOVWF TMP1Y
   CALL CSEND
   BSF  CNT10, 1
   GOTO POP
TMP_OPE
   MOVF OUT, W
   MOVWF OPERATOR
   CALL CSEND
   BSF  CNT10, 2
   BCF  JUDGE, 0
   MOVF OPERATOR, W
   ADDLW B'11010011'
   BTFSS STATUS, C
   BSF  JUDGE, 0
   GOTO POP
TMP_2
   MOVF OUT, W
   MOVWF TMP2X
   CALL CSEND
   BSF  CNT10, 3
   GOTO POP
TMP_3
   MOVF OUT, W
   MOVWF TMP2Y
   CALL CSEND
   BSF  CNT10, 4
   GOTO POP
EQUAL
   MOVF OUT, W
   MOVWF EQUAL
   CALL CSEND
   BSF  CNT10, 5
   GOTO POP 
   
   END